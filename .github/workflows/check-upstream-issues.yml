# Automated upstream issue tracker
# Checks if tracked upstream issues have been resolved and notifies us
#
# This workflow monitors external GitHub issues that block workaround removal.
# When an upstream issue is closed, it comments on our tracking issue.

name: Check Upstream Issues

on:
  schedule:
    # Run every Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Check upstream issues and notify
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Define upstream issues to track
            // Format: { owner, repo, issue_number, our_issue }
            const trackedIssues = [
              {
                owner: 'open-telemetry',
                repo: 'opentelemetry-lambda',
                issue_number: 1891,
                our_issue: 216,
                description: 'OTEL collector deprecated telemetry.metrics.address config'
              }
            ];

            for (const tracked of trackedIssues) {
              console.log(`Checking ${tracked.owner}/${tracked.repo}#${tracked.issue_number}...`);

              try {
                // Get upstream issue status
                const { data: upstreamIssue } = await github.rest.issues.get({
                  owner: tracked.owner,
                  repo: tracked.repo,
                  issue_number: tracked.issue_number
                });

                console.log(`  Status: ${upstreamIssue.state}`);

                if (upstreamIssue.state === 'closed') {
                  // Check if we already commented about this
                  const { data: comments } = await github.rest.issues.listComments({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: tracked.our_issue
                  });

                  const alreadyNotified = comments.some(c =>
                    c.body.includes('Upstream issue has been closed') &&
                    c.body.includes(`${tracked.owner}/${tracked.repo}#${tracked.issue_number}`)
                  );

                  if (!alreadyNotified) {
                    // Post notification comment
                    const issueUrl = `https://github.com/${tracked.owner}/${tracked.repo}/issues/${tracked.issue_number}`;
                    const workflowUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/workflows/check-upstream-issues.yml`;

                    const body = [
                      '## Upstream issue has been closed!',
                      '',
                      'The upstream issue we were tracking has been resolved:',
                      `- Issue: [${tracked.owner}/${tracked.repo}#${tracked.issue_number}](${issueUrl})`,
                      `- Description: ${tracked.description}`,
                      `- Closed at: ${upstreamIssue.closed_at}`,
                      '',
                      'Action required: Review if the workaround can now be removed. Check the upstream fix and verify the ADOT Lambda layer has been updated.',
                      '',
                      '---',
                      `*This comment was automatically generated by the [upstream issue checker](${workflowUrl}).*`
                    ].join('\n');

                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: tracked.our_issue,
                      body: body
                    });

                    console.log(`  Notified on issue #${tracked.our_issue}`);
                  } else {
                    console.log(`  Already notified on issue #${tracked.our_issue}`);
                  }
                }
              } catch (error) {
                console.error(`  Error checking issue: ${error.message}`);
              }
            }
