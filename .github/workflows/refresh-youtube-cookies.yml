name: Refresh YouTube Cookies

on:
  schedule:
    - cron: '0 6 */2 * *'  # Every 2 days at 6am UTC
  workflow_dispatch:
    inputs:
      force:
        description: 'Force cookie refresh even if recent'
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  refresh-cookies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Playwright with Stealth Plugin
        run: |
          npm install -D playwright-extra puppeteer-extra-plugin-stealth playwright @playwright/test
          npx playwright install chromium --with-deps

      - name: Check last refresh time
        id: check
        if: ${{ !inputs.force }}
        run: |
          LAST_MODIFIED=$(git log -1 --format=%ct -- layers/yt-dlp/cookies/youtube-cookies.txt 2>/dev/null || echo 0)
          NOW=$(date +%s)
          AGE_HOURS=$(( (NOW - LAST_MODIFIED) / 3600 ))

          if [ "$AGE_HOURS" -lt 36 ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Cookies refreshed ${AGE_HOURS} hours ago, skipping"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Restore Chromium browser state
        if: steps.check.outputs.skip != 'true'
        uses: actions/cache/restore@v4
        with:
          path: playwright-state
          key: youtube-browser-state-chromium-${{ github.repository }}

      - name: Extract cookies with Chromium + Stealth
        id: chromium_extract
        if: steps.check.outputs.skip != 'true'
        continue-on-error: true
        run: node scripts/extract-youtube-cookies.mjs
        env:
          YOUTUBE_EMAIL: ${{ secrets.YOUTUBE_EMAIL }}
          YOUTUBE_PASSWORD: ${{ secrets.YOUTUBE_PASSWORD }}

      - name: Save Chromium browser state
        if: steps.check.outputs.skip != 'true' && steps.chromium_extract.outcome == 'success'
        uses: actions/cache/save@v4
        with:
          path: playwright-state
          key: youtube-browser-state-chromium-${{ github.repository }}-${{ github.run_id }}

      # Firefox fallback if Chromium fails
      - name: Install Firefox (fallback)
        if: steps.check.outputs.skip != 'true' && steps.chromium_extract.outcome == 'failure'
        run: |
          echo "Chromium extraction failed, trying Firefox fallback..."
          npx playwright install firefox --with-deps

      - name: Restore Firefox browser state
        if: steps.check.outputs.skip != 'true' && steps.chromium_extract.outcome == 'failure'
        uses: actions/cache/restore@v4
        with:
          path: playwright-state-firefox
          key: youtube-browser-state-firefox-${{ github.repository }}

      - name: Extract cookies with Firefox (fallback)
        id: firefox_extract
        if: steps.check.outputs.skip != 'true' && steps.chromium_extract.outcome == 'failure'
        run: node scripts/extract-youtube-cookies-firefox.mjs
        env:
          YOUTUBE_EMAIL: ${{ secrets.YOUTUBE_EMAIL }}
          YOUTUBE_PASSWORD: ${{ secrets.YOUTUBE_PASSWORD }}

      - name: Save Firefox browser state
        if: steps.check.outputs.skip != 'true' && steps.chromium_extract.outcome == 'failure' && steps.firefox_extract.outcome == 'success'
        uses: actions/cache/save@v4
        with:
          path: playwright-state-firefox
          key: youtube-browser-state-firefox-${{ github.repository }}-${{ github.run_id }}

      - name: Verify cookies extracted
        if: steps.check.outputs.skip != 'true'
        run: |
          if [ ! -f layers/yt-dlp/cookies/youtube-cookies.txt ]; then
            echo "ERROR: Cookie file not created"
            exit 1
          fi
          LINES=$(wc -l < layers/yt-dlp/cookies/youtube-cookies.txt)
          if [ "$LINES" -lt 10 ]; then
            echo "ERROR: Cookie file too small (${LINES} lines)"
            exit 1
          fi
          echo "Cookie file valid: ${LINES} lines"

          # Report which browser succeeded
          if [ "${{ steps.chromium_extract.outcome }}" == "success" ]; then
            echo "Cookies extracted successfully with Chromium + Stealth"
          else
            echo "Cookies extracted successfully with Firefox fallback"
          fi

      - name: Ensure required labels exist
        if: steps.check.outputs.skip != 'true'
        run: |
          create_label_if_missing() {
            local name="$1"
            local description="$2"
            local color="$3"

            if ! gh label list --json name --jq '.[].name' | grep -q "^${name}$"; then
              echo "Creating label: ${name}"
              gh label create "${name}" --description "${description}" --color "${color}" || true
            fi
          }

          create_label_if_missing "dependencies" "Dependency updates" "0366d6"
          create_label_if_missing "automated" "Automated by GitHub Actions" "bfd4f2"
          create_label_if_missing "cookies" "Related to YouTube cookies" "f9d0c4"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create PR with updated cookies
        if: steps.check.outputs.skip != 'true'
        run: |
          set -e

          BRANCH_NAME="chore/refresh-youtube-cookies-$(date +%Y%m%d-%H%M)"
          COOKIE_DATE=$(date +%Y-%m-%d)

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          if git diff --quiet layers/yt-dlp/cookies/youtube-cookies.txt; then
            echo "No changes to cookies, skipping PR"
            exit 0
          fi

          git checkout -b "${BRANCH_NAME}"
          git add layers/yt-dlp/cookies/youtube-cookies.txt
          git commit -m "chore: refresh YouTube cookies (${COOKIE_DATE})"
          git push origin "${BRANCH_NAME}"

          # Determine which browser was used
          if [ "${{ steps.chromium_extract.outcome }}" == "success" ]; then
            BROWSER_USED="Chromium with Stealth plugin"
          else
            BROWSER_USED="Firefox (fallback)"
          fi

          cat > /tmp/pr-body.md << EOF
          Automated cookie refresh from GitHub Actions workflow.

          ## What Changed
          - Updated \`layers/yt-dlp/cookies/youtube-cookies.txt\` with fresh session
          - Browser used: **${BROWSER_USED}**

          ## Deployment
          Merge this PR and run \`pnpm run deploy\` to deploy updated cookies to Lambda.

          ## Background
          YouTube cookies expire every 3-5 days. This automated workflow refreshes them
          every 2 days to ensure uninterrupted downloads.

          ## Architecture
          - **Cookies**: Required for authenticated YouTube access
          - **Stealth Plugin**: Evades Google bot detection on Chromium
          - **Firefox Fallback**: Alternative browser if Chromium detection fails
          - **PO Tokens**: Generated by bgutil plugin to bypass bot detection
          - **Combined**: All work together for reliable downloads
          EOF

          gh pr create \
            --title "chore: refresh YouTube cookies" \
            --body-file /tmp/pr-body.md \
            --label "dependencies" \
            --label "automated" \
            --label "cookies"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Upload debug screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: playwright-screenshots/
          if-no-files-found: ignore
          retention-days: 7

      - name: Notify on failure
        if: failure()
        run: |
          # Ensure required labels exist before creating issue
          for label in "bug" "automation" "cookie-expiration"; do
            if ! gh label list --json name --jq '.[].name' | grep -q "^${label}$"; then
              gh label create "${label}" --description "Auto-created" --color "d73a4a" 2>/dev/null || true
            fi
          done

          gh issue create \
            --title "YouTube cookie refresh failed" \
            --body "The automated cookie refresh workflow failed. Both Chromium + Stealth and Firefox fallback were attempted.

          **Workflow run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## What Was Tried
          1. **Chromium + Stealth Plugin**: Primary extraction method with bot detection evasion
          2. **Firefox Fallback**: Secondary method using Firefox browser

          ## Manual Steps
          1. Run \`pnpm run update-cookies\` locally
          2. Commit and push the updated cookies
          3. Deploy with \`pnpm run deploy\`

          ## Troubleshooting
          - Check workflow artifacts for screenshots showing where extraction failed
          - Verify YOUTUBE_EMAIL and YOUTUBE_PASSWORD secrets are set correctly
          - Verify the Google account doesn't have unusual security blocks
          - Try generating an App Password for the account
          - Consider logging into the account manually to clear any security prompts" \
            --label "bug" \
            --label "automation" \
            --label "cookie-expiration"
        env:
          GH_TOKEN: ${{ github.token }}
