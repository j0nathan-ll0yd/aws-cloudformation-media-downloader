name: Unit Tests

on:
  push:
    branches: ['**']
  pull_request:
    branches: [master]

jobs:
  # Parallel job 1: Validation checks (TypeSpec, API docs, config)
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-node-pnpm

      - name: Compile TypeSpec
        run: pnpm run typespec:check

      - name: Generate API documentation
        run: pnpm run document:api

      - name: Validate API path alignment
        run: pnpm run validate:api:paths

      - name: Validate documented scripts exist
        run: ./bin/validate-docs.sh

      - name: Validate documentation sync
        run: pnpm run validate:doc:sync

      - name: Audit wiki documentation
        run: pnpm run audit:wiki

      - name: Validate docs freshness
        run: pnpm run validate:docs:freshness

      - name: Security audit
        run: pnpm audit --audit-level=high

      - name: Validate configuration enforcement
        run: pnpm run validate:config

      - name: Run convention validation
        run: pnpm run validate:conventions

  # Parallel job 2: Type checking and linting
  lint-and-types:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-node-pnpm

      - name: Check types
        run: pnpm run check:types

      - name: Check test types
        run: pnpm run check:test:types

      - name: Lint code
        run: pnpm run lint

      - name: Check formatting
        run: pnpm run format:check

      - name: Run ShellCheck
        run: shellcheck --severity=error bin/*.sh .github/scripts/*.sh

      - name: Test ESLint local rules
        run: pnpm run test:eslint:rules

      - name: Check Terraform formatting
        run: |
          # Install tofu for formatting check
          if command -v tofu &> /dev/null; then
            tofu fmt -check -recursive terraform/
          else
            echo "OpenTofu not installed, skipping Terraform fmt check"
          fi

  # Parallel job 3: Build and validate artifacts
  build-and-validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-node-pnpm
      - uses: ./.github/actions/setup-homebrew-tools
      - uses: ./.github/actions/build-project
        with:
          cache-build: 'true'

      - name: Check bundle sizes
        run: pnpm run check:bundle:size

      - name: Validate GraphRAG synchronization
        run: pnpm run validate:graphrag

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-output
          path: build/
          retention-days: 1

  # Final job: Run tests after all checks pass
  test:
    needs: [validate, lint-and-types, build-and-validate]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-node-pnpm

      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-output
          path: build/

      - name: Run unit tests
        run: pnpm test --coverage 2>&1 | tee test-output.txt
        env:
          CI: true

      - name: Validate test output
        if: always()
        run: |
          # Check for Vitest deprecation warnings
          if grep -q "DEPRECATED" test-output.txt 2>/dev/null; then
            echo "::error::Found Vitest deprecation warnings in test output"
            grep "DEPRECATED" test-output.txt | head -3
            exit 1
          fi

          # Check for EMF metrics spam (Powertools not silenced)
          if grep -q '"_aws".*"CloudWatchMetrics"' test-output.txt 2>/dev/null; then
            echo "::error::Found Powertools EMF metrics in test output (should be silenced)"
            exit 1
          fi

          # Check for MCR source content warnings
          if grep -q '\[MCR\] not found source content' test-output.txt 2>/dev/null; then
            echo "::error::Found MCR source content warnings in test output"
            grep '\[MCR\] not found' test-output.txt | head -3
            exit 1
          fi

          echo "Test output is clean"

      - name: Post coverage to job summary
        if: always() && hashFiles('coverage/unit/coverage-summary.md') != ''
        run: |
          echo "## Unit Test Coverage" >> "$GITHUB_STEP_SUMMARY"
          cat coverage/unit/coverage-summary.md >> "$GITHUB_STEP_SUMMARY"
