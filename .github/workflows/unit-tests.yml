name: Unit Tests

on:
  push:
    branches: ['**']
  pull_request:
    branches: [master]
  workflow_call:

jobs:
  # Parallel job 1: Validation checks (TypeSpec, API docs, config)
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-node-pnpm

      - name: Cache TypeSpec output
        uses: actions/cache@v5
        with:
          path: tsp-output/
          key: typespec-${{ runner.os }}-${{ hashFiles('tsp/**') }}
          restore-keys: |
            typespec-${{ runner.os }}-

      - name: Compile TypeSpec
        run: pnpm run typespec:check

      - name: Generate API documentation
        run: pnpm run document:api

      - name: Validate API path alignment
        run: pnpm run validate:api:paths

      - name: Validate documented scripts exist
        run: ./bin/validate-docs.sh

      - name: Validate documentation sync
        run: pnpm run validate:doc:sync

      - name: Audit wiki documentation
        run: pnpm run audit:wiki

      - name: Validate docs freshness
        run: pnpm run validate:docs:freshness

      - name: Security audit
        # tar v6 vulnerabilities - required for fastembed (devDep for semantic search)
        # fastembed uses default export removed in tar v7; not used in production
        run: |
          pnpm audit --audit-level=high \
            --ignore GHSA-8qq5-rm4j-mr97 \
            --ignore GHSA-r6q2-hw4h-h46w \
            --ignore GHSA-34x7-hfp2-rc4v

      - name: Validate configuration enforcement
        run: pnpm run validate:config

      - name: Run convention validation
        run: pnpm run validate:conventions

      - name: Validate DSQL migration compatibility
        run: |
          echo "Checking Aurora DSQL migration compatibility..."
          errors=0
          for file in migrations/*.sql; do
            [ -f "$file" ] || continue
            # Skip lambda_roles migration (doesn't contain CREATE INDEX)
            if [[ "$file" == *"lambda_roles"* ]]; then
              continue
            fi
            echo "Checking $file..."
            # Strip SQL comments before checking (lines starting with --)
            sql_content=$(grep -v '^[[:space:]]*--' "$file")
            # Check for CREATE INDEX without ASYNC (DSQL requires ASYNC for non-blocking)
            if echo "$sql_content" | grep -qE "CREATE INDEX\s+(?!ASYNC)" 2>/dev/null; then
              # Allow IF NOT EXISTS without ASYNC (idempotent recreations)
              if echo "$sql_content" | grep -E "CREATE INDEX\s+(?!ASYNC)" | grep -qv "IF NOT EXISTS"; then
                echo "ERROR: $file uses CREATE INDEX without ASYNC or IF NOT EXISTS"
                echo "Aurora DSQL requires CREATE INDEX ASYNC for non-blocking index creation"
                errors=$((errors + 1))
              fi
            fi
            # Check for unsupported DSQL features (in actual SQL, not comments)
            if echo "$sql_content" | grep -qi "ALTER TABLE.*DROP COLUMN"; then
              echo "ERROR: $file uses ALTER TABLE DROP COLUMN (not supported in Aurora DSQL)"
              errors=$((errors + 1))
            fi
            if echo "$sql_content" | grep -qi "JSONB"; then
              echo "ERROR: $file uses JSONB (not supported in Aurora DSQL)"
              errors=$((errors + 1))
            fi
          done
          if [ $errors -gt 0 ]; then
            echo "::error::Found $errors DSQL compatibility issues in migrations"
            exit 1
          fi
          echo "All migrations are DSQL-compatible"

  # Parallel job 2: Type checking and linting
  lint-and-types:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-node-pnpm
      - uses: ./.github/actions/setup-homebrew-tools

      - name: Build dependencies (generate infrastructure.d.ts)
        run: pnpm run build:dependencies

      - name: Check types
        run: pnpm run check:types

      - name: Check test types
        run: pnpm run check:test:types

      - name: Lint code
        run: pnpm run lint

      - name: Check formatting
        run: pnpm run format:check

      - name: Run ShellCheck
        run: shellcheck --severity=error bin/*.sh .github/scripts/*.sh

      - name: Test ESLint local rules
        run: pnpm run test:eslint:rules

      - name: Check Terraform formatting
        run: |
          # Install tofu for formatting check
          if command -v tofu &> /dev/null; then
            tofu fmt -check -recursive terraform/
          else
            echo "OpenTofu not installed, skipping Terraform fmt check"
          fi

  # Parallel job 3: Build and validate artifacts
  build-and-validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-node-pnpm
      - uses: ./.github/actions/setup-homebrew-tools
      - uses: ./.github/actions/build-project
        with:
          cache-build: 'true'

      - name: Check bundle sizes
        run: pnpm run check:bundle:size

      - name: Validate GraphRAG synchronization
        run: pnpm run validate:graphrag

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-output
          path: build/
          retention-days: 1

  # Final job: Run tests after all checks pass
  test:
    needs: [validate, lint-and-types, build-and-validate]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-node-pnpm

      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-output
          path: build/

      - name: Run unit tests
        run: pnpm test --coverage 2>&1 | tee test-output.txt
        env:
          CI: true

      - name: Validate test output
        if: always()
        run: |
          # Check for Vitest deprecation warnings
          if grep -q "DEPRECATED" test-output.txt 2>/dev/null; then
            echo "::error::Found Vitest deprecation warnings in test output"
            grep "DEPRECATED" test-output.txt | head -3
            exit 1
          fi

          # Check for EMF metrics spam (Powertools not silenced)
          if grep -q '"_aws".*"CloudWatchMetrics"' test-output.txt 2>/dev/null; then
            echo "::error::Found Powertools EMF metrics in test output (should be silenced)"
            exit 1
          fi

          # Check for MCR source content warnings
          if grep -q '\[MCR\] not found source content' test-output.txt 2>/dev/null; then
            echo "::error::Found MCR source content warnings in test output"
            grep '\[MCR\] not found' test-output.txt | head -3
            exit 1
          fi

          echo "Test output is clean"

      - name: Post coverage to job summary
        if: always() && hashFiles('coverage/unit/coverage-summary.md') != ''
        run: |
          echo "## Unit Test Coverage" >> "$GITHUB_STEP_SUMMARY"
          cat coverage/unit/coverage-summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Post timing summary
        if: always()
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## CI Job Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Job | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Validate | ${{ needs.validate.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Lint & Types | ${{ needs.lint-and-types.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Build | ${{ needs.build-and-validate.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Tests | ${{ job.status }} |" >> "$GITHUB_STEP_SUMMARY"
