name: Unit Tests

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - master

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup pnpm
      uses: pnpm/action-setup@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version-file: '.nvmrc'
        cache: 'pnpm'

    - name: Set up Homebrew
      id: set-up-homebrew
      uses: Homebrew/actions/setup-homebrew@master

    - name: Install hcl2json
      id: brew-install-hcl2json
      run: brew install hcl2json

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Setup directories
      id: setup
      run: mkdir build

    - name: Build dependencies
      id: build-dependencies
      run: pnpm run build-dependencies

    - name: Webpack Build
      id: build
      run: pnpm run build

    - name: Check types
      run: pnpm run check-types

    - name: Lint code
      run: pnpm run lint

    - name: Validate documented scripts exist
      run: |
        # Extract script references from documentation and verify they exist in package.json
        echo "Validating documented scripts..."
        MISSING_SCRIPTS=""

        # Check AGENTS.md for pnpm run commands
        for script in $(grep -oE 'pnpm run [a-z:-]+' AGENTS.md 2>/dev/null | sed 's/pnpm run //' | sort -u); do
          if ! jq -e ".scripts[\"$script\"]" package.json > /dev/null 2>&1; then
            MISSING_SCRIPTS="$MISSING_SCRIPTS $script"
          fi
        done

        # Check README.md for pnpm run commands
        for script in $(grep -oE 'pnpm run [a-z:-]+' README.md 2>/dev/null | sed 's/pnpm run //' | sort -u); do
          if ! jq -e ".scripts[\"$script\"]" package.json > /dev/null 2>&1; then
            MISSING_SCRIPTS="$MISSING_SCRIPTS $script"
          fi
        done

        if [ -n "$MISSING_SCRIPTS" ]; then
          echo "ERROR: The following scripts are documented but not in package.json:"
          echo "$MISSING_SCRIPTS" | tr ' ' '\n' | sort -u | grep -v '^$'
          exit 1
        fi

        echo "âœ“ All documented scripts exist in package.json"

    - name: Run unit tests
      run: pnpm test --coverage --coverageDirectory=coverage/unit
      env:
        CI: true

    - name: Upload unit test coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage/unit/lcov.info
        flags: unit
        name: unit-tests
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: true
