name: Unit Tests

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - master

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup pnpm
      uses: pnpm/action-setup@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version-file: '.nvmrc'
        cache: 'pnpm'

    - name: Set up Homebrew
      id: set-up-homebrew
      uses: Homebrew/actions/setup-homebrew@master

    - name: Install hcl2json
      id: brew-install-hcl2json
      run: brew install hcl2json

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Compile TypeSpec
      run: pnpm run typespec:check

    - name: Setup directories
      id: setup
      run: mkdir build

    - name: Build dependencies
      id: build-dependencies
      run: pnpm run build-dependencies

    - name: Webpack Build
      id: build
      run: pnpm run build

    - name: Check types
      run: pnpm run check-types

    - name: Lint code
      run: pnpm run lint

    - name: Test ESLint local rules
      run: pnpm run test:eslint-rules

    - name: Validate documented scripts exist
      run: ./bin/validate-docs.sh

    - name: Validate documentation sync
      run: pnpm run validate:doc-sync

    - name: Validate configuration enforcement
      run: pnpm run validate:config

    - name: Run unit tests
      run: pnpm test --coverage --coverageDirectory=coverage/unit
      env:
        CI: true

    - name: Upload unit test coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage/unit/lcov.info
        flags: unit
        name: unit-tests
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: true
