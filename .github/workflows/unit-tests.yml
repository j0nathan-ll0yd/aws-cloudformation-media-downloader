name: Unit Tests

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - master

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup pnpm
      uses: pnpm/action-setup@v4

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version-file: '.nvmrc'
        cache: 'pnpm'

    - name: Set up Homebrew
      id: set-up-homebrew
      uses: Homebrew/actions/setup-homebrew@master

    - name: Install hcl2json
      id: brew-install-hcl2json
      run: brew install hcl2json

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Security audit
      run: pnpm audit --audit-level=high

    - name: Compile TypeSpec
      run: pnpm run typespec:check

    - name: Generate API documentation
      run: pnpm run document-api

    - name: Validate API path alignment
      run: pnpm run validate:api-paths

    - name: Setup directories
      id: setup
      run: mkdir build

    - name: Build dependencies
      id: build-dependencies
      run: pnpm run build-dependencies

    - name: Webpack Build
      id: build
      run: pnpm run build

    - name: Check bundle sizes
      run: pnpm run check:bundle-size

    - name: Validate GraphRAG synchronization
      run: pnpm run validate:graphrag

    - name: Check types
      run: pnpm run check-types

    - name: Check test types
      run: pnpm run check-test-types

    - name: Lint code
      run: pnpm run lint

    - name: Check formatting
      run: pnpm run format:check

    - name: Test ESLint local rules
      run: pnpm run test:eslint-rules

    - name: Validate documented scripts exist
      run: ./bin/validate-docs.sh

    - name: Validate documentation sync
      run: pnpm run validate:doc-sync

    - name: Validate configuration enforcement
      run: pnpm run validate:config

    - name: Run unit tests
      run: pnpm test --coverage
      env:
        CI: true

    - name: Post coverage to job summary
      if: always() && hashFiles('coverage/unit/coverage-summary.md') != ''
      run: |
        echo "## Unit Test Coverage" >> "$GITHUB_STEP_SUMMARY"
        cat coverage/unit/coverage-summary.md >> "$GITHUB_STEP_SUMMARY"
