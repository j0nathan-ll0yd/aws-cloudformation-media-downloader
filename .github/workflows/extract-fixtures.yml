name: Weekly Fixture Extraction

on:
  schedule:
    # Run every Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    # Allow manual triggering
    inputs:
      lambda_name:
        description: 'Lambda function name (leave empty for all)'
        required: false
        type: string
      days_back:
        description: 'Number of days to look back'
        required: false
        default: '7'
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  extract-fixtures:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Extract fixtures from CloudWatch
        run: |
          if [ -n "${{ inputs.lambda_name }}" ]; then
            ./bin/extract-fixtures.sh "${{ inputs.lambda_name }}" "${{ inputs.days_back || '7' }}"
          else
            ./bin/extract-fixtures.sh "" "${{ inputs.days_back || '7' }}"
          fi

      - name: Process fixture markers
        run: |
          if [ -n "${{ inputs.lambda_name }}" ]; then
            node bin/process-fixture-markers.js "${{ inputs.lambda_name }}"
          else
            node bin/process-fixture-markers.js
          fi

      - name: Check for extracted fixtures
        id: check_fixtures
        run: |
          if [ -d "src/lambdas" ]; then
            fixture_count=$(find src/lambdas -path "*/test/fixtures/extracted/*.json" 2>/dev/null | wc -l || echo "0")
            echo "fixture_count=$fixture_count" >> $GITHUB_OUTPUT
            echo "Found $fixture_count extracted fixtures"
          else
            echo "fixture_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check_fixtures.outputs.fixture_count > 0
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: Update production fixtures from CloudWatch

            Automatically extracted ${{ steps.check_fixtures.outputs.fixture_count }} fixtures from production CloudWatch Logs.

            Extraction details:
            - Lambda: ${{ inputs.lambda_name || 'all' }}
            - Lookback period: ${{ inputs.days_back || '7' }} days
            - Extraction date: ${{ github.run_id }}
          branch: fixture-extraction/${{ github.run_id }}
          delete-branch: true
          title: 'chore: Update production fixtures (${{ steps.check_fixtures.outputs.fixture_count }} new)'
          body: |
            ## Automated Fixture Extraction

            This PR contains fixtures automatically extracted from production CloudWatch Logs.

            ### Extraction Details
            - **Lambda Function(s)**: ${{ inputs.lambda_name || 'all' }}
            - **Lookback Period**: ${{ inputs.days_back || '7' }} days
            - **Fixtures Extracted**: ${{ steps.check_fixtures.outputs.fixture_count }}
            - **Extraction Date**: ${{ github.run_id }}

            ### Features Applied
            - ✅ Case-insensitive sanitization of sensitive fields
            - ✅ Content-based deduplication (MD5 hashing)
            - ✅ Fixture validation against schema
            - ✅ Provenance metadata tracking

            ### Review Checklist
            - [ ] Verify sensitive data is properly redacted
            - [ ] Review `_metadata` fields for accuracy
            - [ ] Confirm fixtures match expected schemas
            - [ ] Move validated fixtures from `extracted/` to parent directory
            - [ ] Update tests to use new fixtures

            ### Next Steps
            1. Review extracted fixtures in `src/lambdas/*/test/fixtures/extracted/`
            2. Manually verify no sensitive data leaked through
            3. Move validated fixtures to `src/lambdas/*/test/fixtures/`
            4. Update tests to reference new fixture files
            5. Delete old hand-crafted fixtures (if replaced)

            ---
            *This PR was automatically generated by the Weekly Fixture Extraction workflow.*
          labels: |
            automated
            fixtures
            testing
          assignees: j0nathan-ll0yd
          draft: false

      - name: Summary
        run: |
          echo "### Fixture Extraction Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fixtures Extracted**: ${{ steps.check_fixtures.outputs.fixture_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Lambda**: ${{ inputs.lambda_name || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Lookback**: ${{ inputs.days_back || '7' }} days" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_fixtures.outputs.fixture_count }}" -gt "0" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ Pull request created with extracted fixtures" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ℹ️ No new fixtures found" >> $GITHUB_STEP_SUMMARY
          fi
