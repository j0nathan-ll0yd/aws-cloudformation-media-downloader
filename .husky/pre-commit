#!/bin/sh
# pre-commit hook: Run fast validation checks before commit
# This catches architectural violations and code quality issues early
#
# To bypass (emergency only): git commit --no-verify

echo "Running pre-commit checks..."

# Check for dependency violations (fast - usually < 1 second)
echo "Checking dependency architecture..."
if ! pnpm run deps:check; then
  echo ""
  echo "Dependency architecture violations detected."
  echo "Fix the issues or use 'git commit --no-verify' to bypass (emergency only)"
  exit 1
fi

# Check docs/ structure convention (fast - < 1 second)
echo "Checking docs/ structure..."

# POSIX-compliant file/directory validation using case statements
docs_errors=0

for file in docs/*; do
  # Skip if glob didn't match anything
  [ ! -e "$file" ] && continue

  basename_file=$(basename "$file")

  if [ -f "$file" ]; then
    # Check if file is in allowed list
    case "$basename_file" in
      doc-code-mapping.json|doc-code-mapping.schema.json|llms.txt|llms-full.txt|terraform.md)
        # Allowed file
        ;;
      *.md)
        echo "  Markdown file '$basename_file' should be in docs/wiki/, not docs/ root"
        docs_errors=$((docs_errors + 1))
        ;;
      *)
        echo "  Unexpected file '$basename_file' in docs/ root"
        docs_errors=$((docs_errors + 1))
        ;;
    esac
  elif [ -d "$file" ]; then
    # Check if directory is in allowed list
    case "$basename_file" in
      wiki|api|source|archive)
        # Allowed directory
        ;;
      *)
        echo "  Unexpected subdirectory 'docs/$basename_file/' - use docs/wiki/ for documentation"
        docs_errors=$((docs_errors + 1))
        ;;
    esac
  fi
done

if [ $docs_errors -gt 0 ]; then
  echo ""
  echo "docs/ structure violations detected."
  echo "Markdown docs belong in docs/wiki/. Machine files allowed in docs/ root."
  echo "Fix the issues or use 'git commit --no-verify' to bypass (emergency only)"
  exit 1
fi

echo "Pre-commit checks passed"
exit 0
