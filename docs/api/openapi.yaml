openapi: 3.0.0
info:
  title: Offline Media Downloader API
  description: |-
    Offline Media Downloader API

    A serverless AWS media downloader service that downloads media content
    (primarily YouTube videos) and integrates with a companion iOS app for
    offline playback.
  version: 0.0.0
tags:
  - name: Files
  - name: Devices
  - name: Webhooks
  - name: Authentication
paths:
  /device/event:
    post:
      operationId: Devices_logClientEvent
      summary: Log client event
      description: |-
        Log a client-side event for debugging and analytics.

        Receives event data from the iOS client and logs it to CloudWatch
        for later analysis. Used for debugging and usage analytics.
      parameters:
        - name: X-API-Key
          in: header
          required: true
          schema:
            type: string
        - name: X-Device-UUID
          in: header
          required: false
          schema:
            type: string
      responses:
        '204':
          description: 'There is no content to send for this request, but the headers may be useful. '
        '400':
          description: The server could not understand the request due to invalid syntax.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalServerError'
      tags:
        - Devices
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Models.ClientEventRequest'
  /device/register:
    post:
      operationId: Devices_registerDevice
      summary: Register device for push notifications
      description: |-
        Register a device to receive push notifications.

        This is an idempotent operation that:
        1. Creates an AWS SNS endpoint for the device
        2. Associates the device with the authenticated user
        3. Subscribes the device to push notification topics

        Example request: See `tsp/examples/register-device-request.json`

        Example response: See `tsp/examples/register-device-response.json`
      parameters:
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
        - name: X-API-Key
          in: header
          required: true
          schema:
            type: string
      responses:
        '200':
          description: The request has succeeded.
          content:
            application/json:
              schema:
                type: object
                required:
                  - body
                  - requestId
                properties:
                  body:
                    allOf:
                      - $ref: '#/components/schemas/Models.DeviceRegistrationResponse'
                    description: The actual response data
                  requestId:
                    type: string
                    description: Unique request identifier for tracing
                description: |-
                  Standard API response wrapper for successful responses.
                  All 2xx responses are wrapped in this format.
        '201':
          description: The request has succeeded and a new resource has been created as a result.
          content:
            application/json:
              schema:
                type: object
                required:
                  - body
                  - requestId
                properties:
                  body:
                    allOf:
                      - $ref: '#/components/schemas/Models.DeviceRegistrationResponse'
                    description: The actual response data
                  requestId:
                    type: string
                    description: Unique request identifier for tracing
                description: |-
                  Standard API response wrapper for successful responses.
                  All 2xx responses are wrapped in this format.
        '400':
          description: The server could not understand the request due to invalid syntax.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Access is unauthorized.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedError'
        '403':
          description: Access is forbidden.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ForbiddenError'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalServerError'
      tags:
        - Devices
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Models.DeviceRegistrationRequest'
  /feedly:
    post:
      operationId: Webhooks_processFeedlyWebhook
      summary: Process Feedly webhook
      description: |-
        Receive a webhook from Feedly to download media.

        When a webhook is received:
        - If the file exists: associates it with the user and sends push notification
        - If the file doesn't exist: creates it, associates with user, and queues for download

        Background mode can be used to defer immediate download processing.

        Example request: See `tsp/examples/webhook-feedly-request.json`

        Example response: See `tsp/examples/webhook-feedly-response.json`
      parameters:
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
        - name: X-API-Key
          in: header
          required: true
          schema:
            type: string
      responses:
        '200':
          description: The request has succeeded.
          content:
            application/json:
              schema:
                type: object
                required:
                  - body
                  - requestId
                properties:
                  body:
                    allOf:
                      - $ref: '#/components/schemas/Models.WebhookResponse'
                    description: The actual response data
                  requestId:
                    type: string
                    description: Unique request identifier for tracing
                description: |-
                  Standard API response wrapper for successful responses.
                  All 2xx responses are wrapped in this format.
        '202':
          description: The request has been accepted for processing, but processing has not yet completed.
          content:
            application/json:
              schema:
                type: object
                required:
                  - body
                  - requestId
                properties:
                  body:
                    allOf:
                      - $ref: '#/components/schemas/Models.WebhookResponse'
                    description: The actual response data
                  requestId:
                    type: string
                    description: Unique request identifier for tracing
                description: |-
                  Standard API response wrapper for successful responses.
                  All 2xx responses are wrapped in this format.
        '400':
          description: The server could not understand the request due to invalid syntax.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Access is forbidden.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ForbiddenError'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalServerError'
      tags:
        - Webhooks
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Models.FeedlyWebhookRequest'
  /files:
    get:
      operationId: Files_listFiles
      summary: List available files
      description: |-
        List all files available to the authenticated user.

        Returns files based on authentication status:
        - Authenticated users: returns their personal file library
        - Anonymous users: returns a demo file for training purposes
        - Unauthenticated users: returns 401 Unauthorized

        Query parameters:
        - status=all: Returns files in all statuses (Queued, Downloading, Downloaded, Failed)
        - status=downloaded (default): Returns only downloaded files

        Example response: See `tsp/examples/list-files-response.json`
      parameters:
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
        - name: X-API-Key
          in: header
          required: true
          schema:
            type: string
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum:
              - all
              - downloaded
          explode: false
      responses:
        '200':
          description: The request has succeeded.
          content:
            application/json:
              schema:
                type: object
                required:
                  - body
                  - requestId
                properties:
                  body:
                    allOf:
                      - $ref: '#/components/schemas/Models.FileListResponse'
                    description: The actual response data
                  requestId:
                    type: string
                    description: Unique request identifier for tracing
                description: |-
                  Standard API response wrapper for successful responses.
                  All 2xx responses are wrapped in this format.
        '401':
          description: Access is unauthorized.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedError'
        '403':
          description: Access is forbidden.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ForbiddenError'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalServerError'
      tags:
        - Files
  /user:
    delete:
      operationId: Authentication_deleteUser
      summary: Delete user account
      description: |-
        Delete user account and all associated data.

        Required for Sign in with Apple compliance (account deletion requirement).
        Deletes user files, devices, and the user record itself.
      parameters:
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
        - name: X-API-Key
          in: header
          required: true
          schema:
            type: string
      responses:
        '204':
          description: 'There is no content to send for this request, but the headers may be useful. '
        '207':
          description: Successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Access is unauthorized.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedError'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalServerError'
      tags:
        - Authentication
  /user/login:
    post:
      operationId: Authentication_loginUser
      summary: Login existing user
      description: |-
        Login an existing user with Sign in with Apple.

        Authenticates a user and returns a JWT access token.

        Example request: See `tsp/examples/login-user-request.json`

        Example response: See `tsp/examples/login-user-response.json`
      parameters:
        - name: X-API-Key
          in: header
          required: true
          schema:
            type: string
      responses:
        '200':
          description: The request has succeeded.
          content:
            application/json:
              schema:
                type: object
                required:
                  - body
                  - requestId
                properties:
                  body:
                    allOf:
                      - $ref: '#/components/schemas/Models.UserLoginResponse'
                    description: The actual response data
                  requestId:
                    type: string
                    description: Unique request identifier for tracing
                description: |-
                  Standard API response wrapper for successful responses.
                  All 2xx responses are wrapped in this format.
        '400':
          description: The server could not understand the request due to invalid syntax.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Access is forbidden.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ForbiddenError'
        '404':
          description: The server cannot find the requested resource.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: The request conflicts with the current state of the server.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalServerError'
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Models.UserLoginRequest'
  /user/logout:
    post:
      operationId: Authentication_logoutUser
      summary: Log out current session
      description: |-
        Log out current session.

        Invalidates the user's current session by deleting it from the database.
        The user will need to re-authenticate to access protected resources.
      parameters:
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
        - name: X-API-Key
          in: header
          required: true
          schema:
            type: string
      responses:
        '204':
          description: 'There is no content to send for this request, but the headers may be useful. '
        '401':
          description: Access is unauthorized.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedError'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalServerError'
      tags:
        - Authentication
  /user/refresh:
    post:
      operationId: Authentication_refreshToken
      summary: Refresh session token
      description: |-
        Refresh an existing session token.

        Extends the session expiration time without re-authenticating.
        The same token is returned with an updated expiration time.
      parameters:
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
        - name: X-API-Key
          in: header
          required: true
          schema:
            type: string
      responses:
        '200':
          description: The request has succeeded.
          content:
            application/json:
              schema:
                type: object
                required:
                  - body
                  - requestId
                properties:
                  body:
                    allOf:
                      - $ref: '#/components/schemas/Models.TokenRefreshResponse'
                    description: The actual response data
                  requestId:
                    type: string
                    description: Unique request identifier for tracing
                description: |-
                  Standard API response wrapper for successful responses.
                  All 2xx responses are wrapped in this format.
        '401':
          description: Access is unauthorized.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedError'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalServerError'
      tags:
        - Authentication
  /user/register:
    post:
      operationId: Authentication_registerUser
      summary: Register new user
      description: |-
        Register a new user with Sign in with Apple.

        Creates a new user account or returns existing user token.
        All user details are sourced from the Apple identity token.

        Example request: See `tsp/examples/register-user-request.json`

        Example response: See `tsp/examples/register-user-response.json`
      parameters:
        - name: X-API-Key
          in: header
          required: true
          schema:
            type: string
      responses:
        '200':
          description: The request has succeeded.
          content:
            application/json:
              schema:
                type: object
                required:
                  - body
                  - requestId
                properties:
                  body:
                    allOf:
                      - $ref: '#/components/schemas/Models.UserRegistrationResponse'
                    description: The actual response data
                  requestId:
                    type: string
                    description: Unique request identifier for tracing
                description: |-
                  Standard API response wrapper for successful responses.
                  All 2xx responses are wrapped in this format.
        '400':
          description: The server could not understand the request due to invalid syntax.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Access is forbidden.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ForbiddenError'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalServerError'
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Models.UserRegistrationRequest'
  /user/subscribe:
    post:
      operationId: Authentication_subscribeUser
      summary: Subscribe to notifications
      description: |-
        Subscribe a user's device to push notification topics.

        Links an SNS endpoint (device) to an SNS topic for receiving notifications.
      parameters:
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
        - name: X-API-Key
          in: header
          required: true
          schema:
            type: string
      responses:
        '201':
          description: The request has succeeded and a new resource has been created as a result.
          content:
            application/json:
              schema:
                type: object
                required:
                  - body
                  - requestId
                properties:
                  body:
                    allOf:
                      - $ref: '#/components/schemas/Models.UserSubscriptionResponse'
                    description: The actual response data
                  requestId:
                    type: string
                    description: Unique request identifier for tracing
                description: |-
                  Standard API response wrapper for successful responses.
                  All 2xx responses are wrapped in this format.
        '400':
          description: The server could not understand the request due to invalid syntax.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Access is unauthorized.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedError'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalServerError'
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Models.UserSubscriptionRequest'
components:
  schemas:
    ErrorResponse:
      type: object
      required:
        - error
        - requestId
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              description: Error code
            message:
              type: string
              description: Error message
          required:
            - code
            - message
          description: Error details
        requestId:
          type: string
          description: Request ID for tracking
      description: Common error response structure
    ForbiddenError:
      type: object
      required:
        - error
        - requestId
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              description: |-
                Error code - typically "Forbidden" for 403 responses, but may vary
                based on API Gateway configuration
            message:
              type: string
              description: Human-readable error message describing the authorization failure
          required:
            - code
            - message
          description: Error details
        requestId:
          type: string
          description: Request ID for tracking and debugging
      description: |-
        Forbidden error response (403)

        Returned when the API key is invalid or the request is not authorized.
        This is NOT related to session tokens - see UnauthorizedError (401) for session issues.

        Common causes:
        - API key is missing from query parameters
        - API key is invalid or disabled
        - Request is not allowed for this API key
    InternalServerError:
      type: object
      required:
        - error
        - requestId
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              description: Error code - typically "InternalServerError" for 500 responses
            message:
              type: string
              description: Error message
          required:
            - code
            - message
          description: Error details
        requestId:
          type: string
          description: Request ID for tracking
      description: Internal Server Error response (500)
    Models.ClientEventRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: The event message or payload to log
      description: Client event request for logging
    Models.Device:
      type: object
      required:
        - deviceId
        - name
        - systemName
        - systemVersion
        - token
      properties:
        deviceId:
          type: string
          description: Unique device identifier (UUID)
        name:
          type: string
          description: Device name
        systemName:
          type: string
          description: Operating system name
        systemVersion:
          type: string
          description: Operating system version
        token:
          type: string
          description: Device push notification token
        endpointArn:
          type: string
          description: AWS SNS endpoint ARN (returned after registration)
      description: Device information for push notifications
    Models.DeviceRegistrationRequest:
      type: object
      required:
        - deviceId
        - name
        - systemName
        - systemVersion
        - token
      properties:
        deviceId:
          type: string
          description: Unique device identifier (UUID)
        name:
          type: string
          description: Device name
        systemName:
          type: string
          description: Operating system name
        systemVersion:
          type: string
          description: Operating system version
        token:
          type: string
          description: Device push notification token (APNS token)
      description: Device registration request
    Models.DeviceRegistrationResponse:
      type: object
      required:
        - endpointArn
      properties:
        endpointArn:
          type: string
          description: AWS SNS endpoint ARN for the registered device
      description: Device registration response
    Models.FeedlyWebhookRequest:
      type: object
      required:
        - articleURL
      properties:
        articleFirstImageURL:
          type: string
          format: uri
          description: URL of the first image in the article
        articleCategories:
          type: string
          description: Categories associated with the article
        articlePublishedAt:
          type: string
          description: Publication date of the article
        articleTitle:
          type: string
          description: Title of the article
        articleURL:
          type: string
          format: uri
          description: URL of the article (typically a YouTube video URL)
        createdAt:
          type: string
          description: Timestamp when the webhook was created
        sourceFeedURL:
          type: string
          format: uri
          description: URL of the source feed
        sourceTitle:
          type: string
          description: Title of the source
        sourceURL:
          type: string
          format: uri
          description: URL of the source
        backgroundMode:
          type: boolean
          description: Whether the webhook was triggered in background mode
      description: Feedly webhook request
    Models.File:
      type: object
      required:
        - fileId
      properties:
        fileId:
          type: string
          description: The unique file identifier (typically a YouTube video ID)
        key:
          type: string
          description: The filename or key in S3 storage
        size:
          type: integer
          format: int64
          description: Size in bytes of the file
        status:
          allOf:
            - $ref: '#/components/schemas/Models.FileStatus'
          description: Current status of the file
        title:
          type: string
          description: Title of the media file
        publishDate:
          type: string
          description: Video publish date
        authorName:
          type: string
          description: Channel/author display name
        authorUser:
          type: string
          description: Channel/author username or ID
        contentType:
          type: string
          description: MIME type (e.g., video/mp4)
        description:
          type: string
          description: Video description
        url:
          type: string
          format: uri
          description: CloudFront URL for downloading the file
      description: A media file available for download
    Models.FileListResponse:
      type: object
      required:
        - contents
        - keyCount
      properties:
        contents:
          type: array
          items:
            $ref: '#/components/schemas/Models.File'
          description: Array of available files
        keyCount:
          type: integer
          format: int32
          description: Number of files returned
      description: Response containing a list of files
    Models.FileStatus:
      type: string
      enum:
        - Queued
        - Downloading
        - Downloaded
        - Failed
      description: File status enumeration
    Models.TokenRefreshResponse:
      type: object
      required:
        - token
        - expiresAt
        - sessionId
        - userId
      properties:
        token:
          type: string
          description: JWT access token (same token, extended expiration)
        expiresAt:
          type: string
          description: ISO 8601 timestamp when the session expires
        sessionId:
          type: string
          description: Session identifier
        userId:
          type: string
          description: User identifier
      description: Token refresh response
    Models.UserLoginRequest:
      type: object
      required:
        - idToken
      properties:
        idToken:
          type: string
          description: Identity token from Sign in with Apple (JWT)
      description: User login request
    Models.UserLoginResponse:
      type: object
      required:
        - token
        - expiresAt
        - sessionId
        - userId
      properties:
        token:
          type: string
          description: JWT access token for authenticated requests
        expiresAt:
          type: string
          description: ISO 8601 timestamp when the session expires
        sessionId:
          type: string
          description: Session identifier
        userId:
          type: string
          description: User identifier
      description: User login response
    Models.UserRegistrationRequest:
      type: object
      required:
        - idToken
      properties:
        idToken:
          type: string
          description: Identity token from Sign in with Apple (JWT)
        firstName:
          type: string
          description: User's first name
        lastName:
          type: string
          description: User's last name
      description: User registration request
    Models.UserRegistrationResponse:
      type: object
      required:
        - token
        - expiresAt
        - sessionId
        - userId
      properties:
        token:
          type: string
          description: JWT access token for authenticated requests
        expiresAt:
          type: string
          description: ISO 8601 timestamp when the session expires
        sessionId:
          type: string
          description: Session identifier
        userId:
          type: string
          description: User identifier
      description: User registration response
    Models.UserSubscriptionRequest:
      type: object
      required:
        - endpointArn
        - topicArn
      properties:
        endpointArn:
          type: string
          description: AWS SNS endpoint ARN for the device
        topicArn:
          type: string
          description: AWS SNS topic ARN to subscribe to
      description: User subscription request
    Models.UserSubscriptionResponse:
      type: object
      required:
        - subscriptionArn
      properties:
        subscriptionArn:
          type: string
          description: AWS SNS subscription ARN
      description: User subscription response
    Models.WebhookResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum:
            - Dispatched
            - Initiated
            - Accepted
          description: Status of the webhook processing
      description: Webhook processing response
    UnauthorizedError:
      type: object
      required:
        - error
        - requestId
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              description: |-
                Error code - typically "Unauthorized" for 401 responses, but may vary
                based on API Gateway configuration (e.g., "custom-4XX-generic")
            message:
              type: string
              description: |-
                Human-readable error message describing the authentication failure.
                Examples: "Invalid session token", "Session expired", "Authorization header missing"
          required:
            - code
            - message
          description: Error details
        requestId:
          type: string
          description: Request ID for tracking and debugging
      description: |-
        Unauthorized error response (401)

        Returned when authentication fails. The iOS app MUST handle this by:
        1. Clearing stored session tokens
        2. Prompting user to re-authenticate via Sign in with Apple

        Common causes:
        - Session token is invalid or malformed
        - Session token has expired (sessions expire after 30 days of inactivity)
        - Authorization header is missing on a protected endpoint
        - Bearer token format is invalid

        Note: This is distinct from 403 Forbidden, which indicates the API key
        is invalid (not the session token).
servers:
  - url: https://api.example.com
    description: Production server
    variables: {}
