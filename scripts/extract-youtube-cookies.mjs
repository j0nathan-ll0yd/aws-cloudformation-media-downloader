/* global console, process */
// scripts/extract-youtube-cookies.mjs
// Extracts YouTube cookies using Playwright with persistent browser state
// Used by GitHub Actions workflow for automated cookie refresh
// @see https://playwright.dev/docs/auth

import {chromium} from 'playwright'
import {existsSync, mkdirSync, writeFileSync} from 'fs'
import {dirname, join} from 'path'
import {fileURLToPath} from 'url'

const __dirname = dirname(fileURLToPath(import.meta.url))
const PROJECT_ROOT = join(__dirname, '..')
const STATE_DIR = join(PROJECT_ROOT, 'playwright-state')
const COOKIES_OUTPUT = join(PROJECT_ROOT, 'layers/yt-dlp/cookies/youtube-cookies.txt')

/** Convert browser cookies to Netscape cookie format */
function toNetscapeFormat(cookies) {
  const header = [
    '# Netscape HTTP Cookie File',
    '# Generated by Playwright cookie extraction',
    '# https://github.com/j0nathan-ll0yd/aws-cloudformation-media-downloader',
    ''
  ].join('\n')
  const lines = cookies.map((c) => {
    const domain = c.domain.startsWith('.') ? c.domain : `.${c.domain}`
    const flag = c.domain.startsWith('.') ? 'TRUE' : 'FALSE'
    const path = c.path || '/'
    const secure = c.secure ? 'TRUE' : 'FALSE'
    const expiry = c.expires ? Math.floor(c.expires) : '0'
    return `${domain}\t${flag}\t${path}\t${secure}\t${expiry}\t${c.name}\t${c.value}`
  })
  return header + lines.join('\n') + '\n'
}

/** Main extraction function */
async function extractCookies() {
  console.log('Starting YouTube cookie extraction...')
  if (!existsSync(STATE_DIR)) {
    mkdirSync(STATE_DIR, {recursive: true})
  }

  // Ensure output directory exists
  const cookiesDir = dirname(COOKIES_OUTPUT)
  if (!existsSync(cookiesDir)) {
    mkdirSync(cookiesDir, {recursive: true})
  }

  const browser = await chromium.launchPersistentContext(STATE_DIR, {headless: true, args: ['--disable-blink-features=AutomationControlled']})
  const page = await browser.newPage()

  try {
    // Navigate to YouTube to refresh session
    console.log('Navigating to YouTube...')
    await page.goto('https://www.youtube.com', {waitUntil: 'networkidle', timeout: 60000})

    // Check if logged in by looking for avatar button
    const isLoggedIn = await page.locator('button#avatar-btn').isVisible({timeout: 5000}).catch(() => false)

    if (!isLoggedIn) {
      console.log('Not logged in. Attempting login...')
      if (!process.env.YOUTUBE_EMAIL || !process.env.YOUTUBE_PASSWORD) {
        throw new Error('YOUTUBE_EMAIL and YOUTUBE_PASSWORD environment variables required')
      }

      // Click sign in button
      await page.click('a[href*="accounts.google.com"]')
      await page.waitForURL(/accounts\.google\.com/, {timeout: 30000})

      // Enter email
      console.log('Entering email...')
      await page.fill('input[type="email"]', process.env.YOUTUBE_EMAIL)
      await page.click('#identifierNext')

      // Wait and enter password
      await page.waitForSelector('input[type="password"]', {state: 'visible', timeout: 30000})
      console.log('Entering password...')
      await page.fill('input[type="password"]', process.env.YOUTUBE_PASSWORD)
      await page.click('#passwordNext')

      // Wait for redirect back to YouTube
      console.log('Waiting for login completion...')
      await page.waitForURL(/youtube\.com/, {timeout: 60000})
      await page.waitForTimeout(3000) // Additional wait for session to settle
    } else {
      console.log('Already logged in, refreshing session...')
      await page.goto('https://www.youtube.com/feed/subscriptions', {waitUntil: 'networkidle'})
      await page.waitForTimeout(2000)
    }

    // Get all cookies and filter to YouTube/Google domains
    console.log('Extracting cookies...')
    const cookies = await browser.cookies()
    const relevantDomains = ['.youtube.com', '.google.com', '.googlevideo.com', 'youtube.com', 'google.com']
    const filteredCookies = cookies.filter((c) => relevantDomains.some((d) => c.domain.endsWith(d) || c.domain === d.slice(1) || c.domain === d))
    console.log(`Found ${filteredCookies.length} relevant cookies`)

    // Convert to Netscape format and write
    const netscapeContent = toNetscapeFormat(filteredCookies)
    writeFileSync(COOKIES_OUTPUT, netscapeContent)
    console.log(`Successfully wrote ${filteredCookies.length} cookies to ${COOKIES_OUTPUT}`)
  } finally {
    await browser.close()
  }
}

extractCookies().catch((err) => {
  console.error('Cookie extraction failed:', err)
  process.exit(1)
})
