# Cursor Rules for AWS CloudFormation Media Downloader

## Primary Reference

This file is a condensed reference. For comprehensive documentation, read `AGENTS.md`.

## 5 Critical Rules (Zero Tolerance)

### 1. Vendor Encapsulation (CRITICAL)
```typescript
// WRONG - Direct AWS SDK import
import {S3Client} from '@aws-sdk/client-s3'

// RIGHT - Use vendor wrapper
import {getS3Client} from '#lib/vendor/AWS/S3'
```
**Applies to**: AWS SDK, Drizzle ORM, Better Auth, yt-dlp

### 2. Entity Mocking (CRITICAL)
```typescript
// WRONG - Legacy module mock
vi.mock('#entities/Users', () => ({...}))

// RIGHT - Query function mock
vi.mock('#entities/queries', () => ({
  getUser: vi.fn(),
  createUser: vi.fn()
}))
```

### 3. No AI Attribution in Commits (CRITICAL)
```bash
# WRONG
git commit -m "feat: add feature ðŸš€ Generated with Claude"

# RIGHT
git commit -m "feat: add user authentication"
```
No emojis, no "Claude", no "AI", no "Co-Authored-By: AI"

### 4. Cascade Deletions (CRITICAL)
```typescript
// WRONG - May leave orphaned data
await Promise.all([deleteUser(), deleteUserFiles()])

// RIGHT - Handle partial failures, delete children first
await Promise.allSettled([deleteUserFiles(), deleteUserDevices()])
await deleteUser()
```

### 5. Response Helpers (HIGH)
```typescript
// WRONG - Raw response
return {statusCode: 200, body: JSON.stringify(data)}

// RIGHT - Use helper
import {response} from '#util/response'
return response(200, data)
```

## Cursor-Specific Patterns

### File Search Priority
1. `build/graph.json` - Dependency analysis (query with jq)
2. `docs/wiki/Meta/Conventions-Tracking.md` - Active conventions
3. `AGENTS.md` - Full project context

### Code Generation Guidelines

#### Lambda Handler Pattern
```typescript
import {Tracer} from '@aws-lambda-powertools/tracer'
import {createAuthenticatedHandler} from '#util/createAuthenticatedHandler'
import {response} from '#util/response'
import {ResponseStatus} from '#types/enums'

const tracer = new Tracer()

export const handler = createAuthenticatedHandler(async (event, userId) => {
  // Handler logic
  return response(200, {status: ResponseStatus.Success})
})
```

#### Test File Pattern
```typescript
import {describe, it, expect, vi, beforeEach} from 'vitest'
import type {Mock} from 'vitest'

// Mock dependencies BEFORE imports
vi.mock('#entities/queries', () => ({
  getUser: vi.fn()
}))

import {handler} from '../src/index'
import {getUser} from '#entities/queries'

describe('LambdaName', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  it('should handle success case', async () => {
    ;(getUser as Mock).mockResolvedValue({userId: 'test'})
    // Test implementation
  })
})
```

## Essential Commands

```bash
pnpm run precheck         # Type check + lint (run before commits)
pnpm run format           # Auto-format with dprint
pnpm run test             # Run unit tests
pnpm run validate:conventions  # AST-based convention checks
pnpm run ci:local         # Fast CI checks
```

## Key Resources

| Resource | Path |
|----------|------|
| Full Context | `AGENTS.md` |
| Active Conventions | `docs/wiki/Meta/Conventions-Tracking.md` |
| Dependencies | `build/graph.json` |
| Lambda Patterns | `docs/wiki/TypeScript/Lambda-Function-Patterns.md` |
| Testing Guide | `docs/wiki/Testing/Vitest-Mocking-Strategy.md` |
| Vendor Policy | `docs/wiki/Conventions/Vendor-Encapsulation-Policy.md` |

## Don't

- Import AWS SDK directly (use `#lib/vendor/AWS/*`)
- Import Drizzle directly (use `#lib/vendor/Drizzle/*`)
- Use `vi.mock('#entities/Users')` (use `#entities/queries`)
- Use underscore-prefixed unused variables (`_context`)
- Add AI references to commits
- Use `Promise.all` for cascade deletions
- Return raw `{statusCode, body}` objects
- Call `getRequiredEnv()` at module level
